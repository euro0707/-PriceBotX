<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é€šçŸ¥è¨­å®š | PriceBotX</title>
</head>
<body>
<!-- é€šçŸ¥è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
<div style="max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
  <h2>é€šçŸ¥è¨­å®š</h2>

  <!-- é€šçŸ¥æ–¹æ³• -->
  <p>é€šçŸ¥æ–¹æ³•</p>
  <label><input type="radio" name="notify-method" value="line" id="method-line" checked> LINE</label>
  <label style="margin-left: 10px;"><input type="radio" name="notify-method" value="email" id="method-email"> ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</label>

  <!-- LINEãƒˆãƒ¼ã‚¯ãƒ³ -->
  <div id="line-section" style="margin-top: 10px;">
    <label for="line-token">LINEãƒˆãƒ¼ã‚¯ãƒ³</label>
    <input type="text" id="line-token" placeholder="ä¾‹ï¼‰abcd1234..." style="width: 100%; margin-bottom: 4px;">
    <small>â€» LINE Notifyã§ç™ºè¡Œã—ãŸã€Œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
    ç™ºè¡Œã¯ã“ã¡ã‚‰ï¼š<a href="https://notify-bot.line.me/my/" target="_blank">notify-bot.line.me/my/</a></small>
  </div>

  <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
  <div id="email-section" style="margin-top: 10px; display: none;">
    <label for="email-address">é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
    <input type="email" id="email-address" placeholder="ä¾‹ï¼‰example@gmail.com" style="width: 100%;">
  </div>

  <!-- å¸Œæœ›ä¾¡æ ¼ -->
  <div style="margin-top: 10px;">
    <label for="price">å¸Œæœ›ä¾¡æ ¼</label>
    <input type="number" id="price" placeholder="ä¾‹ï¼‰3000ï¼ˆå††ï¼‰" style="width: 100%;">
  </div>

  <!-- é€šçŸ¥ON/OFF -->
  <div style="margin-top: 10px;">
    <label for="notify-toggle">é€šçŸ¥ON/OFF</label><br>
    <input type="checkbox" id="notify-toggle" checked>
  </div>

  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <button id="save-button" style="margin-top: 20px; width: 100%; background: #28a745; color: white; padding: 10px; border: none; border-radius: 5px;">ä¿å­˜</button>
</div>

<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
  // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById("method-line").addEventListener("change", () => {
    document.getElementById("line-section").style.display = "block";
    document.getElementById("email-section").style.display = "none";
  });
  document.getElementById("method-email").addEventListener("change", () => {
    document.getElementById("line-section").style.display = "none";
    document.getElementById("email-section").style.display = "block";
  });

  // é€šçŸ¥æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã¨LINEé€ä¿¡å‡¦ç†
  function checkAndNotify(data, current_price) {
    console.log("âœ… ç¾åœ¨ä¾¡æ ¼:", current_price);
    console.log("ğŸ¯ å¸Œæœ›ä¾¡æ ¼:", data.target_price);
    console.log("ğŸ”” é€šçŸ¥ON:", data.notify_enabled);

    if (data.notify_enabled && current_price <= data.target_price) {
      console.log("ğŸ“¤ é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™");

      if (data.method === "line" && data.line_token) {
        fetch("https://notify-api.line.me/api/notify", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${data.line_token}`,
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            message: `ğŸ“¢ å•†å“ä¾¡æ ¼ãŒä¸‹ãŒã‚Šã¾ã—ãŸï¼\nç¾åœ¨ä¾¡æ ¼: Â¥${current_price}\nå¸Œæœ›ä¾¡æ ¼: Â¥${data.target_price}`
          })
        })
        .then(response => {
          if (response.ok) {
            alert("LINEã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
          } else {
            alert("LINEé€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        })
        .catch(error => {
          console.error("é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
          alert("é€šçŸ¥é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        });
      } else {
        console.log("ğŸ“­ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¯æœªå¯¾å¿œï¼ˆæ¬¡ã‚¹ãƒ†ãƒƒãƒ—ï¼‰");
      }
    } else {
      console.log("â¸ é€šçŸ¥æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“");
    }
  }

  // ä¿å­˜å‡¦ç†
  document.getElementById("save-button").addEventListener("click", function () {
    const method = document.querySelector('input[name="notify-method"]:checked').value;
    const targetPrice = parseInt(document.getElementById("price").value);
    const notifyEnabled = document.getElementById("notify-toggle").checked;

    const data = {
      method: method,
      line_token: method === "line" ? document.getElementById("line-token").value : "",
      email: method === "email" ? document.getElementById("email-address").value : "",
      target_price: targetPrice,
      notify_enabled: notifyEnabled
    };

    console.log("ğŸ“ ä¿å­˜ã•ã‚ŒãŸé€šçŸ¥è¨­å®šï¼š", data);
    alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");

    // ä»®ã®ç¾åœ¨ä¾¡æ ¼ï¼ˆã“ã“ã¯APIãªã©ã§å¾Œã«ç½®ãæ›ãˆã‚‹æƒ³å®šï¼‰
    const current_price = 2800;
    checkAndNotify(data, current_price);
  });
</script>
</body>
</html>
